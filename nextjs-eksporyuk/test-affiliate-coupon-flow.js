const { PrismaClient } = require('@prisma/client')
const prisma = new PrismaClient()

async function testFlow() {
  try {
    console.log('üß™ COMPREHENSIVE AFFILIATE COUPON GENERATION TEST\n')
    
    // 1. Verify user exists
    console.log('1Ô∏è‚É£ Checking affiliate user...')
    const user = await prisma.user.findUnique({
      where: { email: 'azizbiasa@gmail.com' },
      select: { id: true, email: true, name: true, role: true }
    })
    
    if (!user) {
      console.log('   ‚ùå User not found')
      return
    }
    console.log(`   ‚úÖ User found: ${user.name} (${user.role})`)
    console.log(`   ID: ${user.id}\n`)
    
    // 2. Get available templates
    console.log('2Ô∏è‚É£ Fetching available templates...')
    const templates = await prisma.coupon.findMany({
      where: { isActive: true, isAffiliateEnabled: true, basedOnCouponId: null },
      select: { id: true, code: true, discountValue: true, discountType: true, maxGeneratePerAffiliate: true }
    })
    
    if (templates.length === 0) {
      console.log('   ‚ùå No templates found')
      return
    }
    
    console.log(`   ‚úÖ Found ${templates.length} templates:`)
    templates.forEach(t => {
      console.log(`   - ${t.code}: ${t.discountValue}${t.discountType === 'PERCENTAGE' ? '%' : ' IDR'} (max ${t.maxGeneratePerAffiliate || 'unlimited'})`)
    })
    console.log('')
    
    // 3. For each template, check generated count and try to generate new coupon
    for (const template of templates) {
      console.log(`3Ô∏è‚É£ Processing template: ${template.code}`)
      
      // Check current generated count
      const generatedCount = await prisma.coupon.count({
        where: { basedOnCouponId: template.id, createdBy: user.id }
      })
      
      console.log(`   Current generated: ${generatedCount}/${template.maxGeneratePerAffiliate || 'unlimited'}`)
      
      // Check if can generate more
      if (template.maxGeneratePerAffiliate && generatedCount >= template.maxGeneratePerAffiliate) {
        console.log(`   ‚ö†Ô∏è  Limit reached, cannot generate more`)
        console.log('')
        continue
      }
      
      // Try to generate new coupon
      const newCode = `${template.code}-TEST-${Date.now().toString().slice(-6)}`
      
      try {
        const newCoupon = await prisma.coupon.create({
          data: {
            id: `coupon-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`,
            code: newCode,
            description: `Generated from ${template.code} template`,
            discountType: template.discountType,
            discountValue: template.discountValue,
            isActive: true,
            basedOnCouponId: template.id,
            createdBy: user.id,
          }
        })
        
        console.log(`   ‚úÖ New coupon created:`)
        console.log(`      Code: ${newCoupon.code}`)
        console.log(`      CreatedAt: ${newCoupon.createdAt}`)
        
        // Verify it was saved
        const verify = await prisma.coupon.findUnique({
          where: { id: newCoupon.id }
        })
        
        if (verify) {
          console.log(`   ‚úÖ VERIFIED: Coupon saved to database`)
        } else {
          console.log(`   ‚ùå ERROR: Coupon not found after creation!`)
        }
      } catch (err) {
        console.log(`   ‚ùå Error creating coupon: ${err.message}`)
      }
      
      console.log('')
    }
    
    // 4. List all coupons generated by this user
    console.log('4Ô∏è‚É£ Listing all coupons generated by this user:')
    const allGenerated = await prisma.coupon.findMany({
      where: { createdBy: user.id, basedOnCouponId: { not: null } },
      select: { code: true, basedOnCouponId: true, createdAt: true },
      orderBy: { createdAt: 'desc' }
    })
    
    if (allGenerated.length === 0) {
      console.log('   (none)')
    } else {
      allGenerated.forEach((c, i) => {
        console.log(`   ${i + 1}. ${c.code} - Created ${c.createdAt.toLocaleString()}`)
      })
    }
    
    console.log(`\nüìä SUMMARY:`)
    console.log(`   User: ${user.name} (${user.role})`)
    console.log(`   Templates available: ${templates.length}`)
    console.log(`   Coupons generated: ${allGenerated.length}`)
    
  } catch (error) {
    console.error('‚ùå Fatal error:', error.message)
    if (error.meta) console.error('Details:', error.meta)
  } finally {
    await prisma.$disconnect()
  }
}

testFlow()
