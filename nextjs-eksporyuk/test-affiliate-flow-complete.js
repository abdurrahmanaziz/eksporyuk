const { PrismaClient } = require('@prisma/client')
const prisma = new PrismaClient()

async function testCompleteFlow() {
  try {
    const userId = 'cmjmtotzh001eitz0kq029lk5' // azizbiasa@gmail.com
    
    console.log('üß™ AFFILIATE COUPON GENERATION - COMPLETE FLOW TEST\n')
    
    // 1. Get EKSPORYUK template
    const template = await prisma.coupon.findUnique({
      where: { code: 'EKSPORYUK' }
    })
    
    if (!template) {
      console.log('‚ùå Template not found')
      return
    }
    
    console.log('1Ô∏è‚É£ Template found:')
    console.log('   Code:', template.code)
    console.log('   Max Generate:', template.maxGeneratePerAffiliate)
    console.log('   Active:', template.isActive)
    console.log('   Affiliate Enabled:', template.isAffiliateEnabled)
    console.log('')
    
    // 2. Check if user can generate (should be true - 0 generated)
    const currentGenerated = await prisma.coupon.count({
      where: { basedOnCouponId: template.id, createdBy: userId }
    })
    
    console.log('2Ô∏è‚É£ Current generated by user: ' + currentGenerated)
    console.log('   Limit: ' + template.maxGeneratePerAffiliate)
    
    if (currentGenerated >= template.maxGeneratePerAffiliate) {
      console.log('   ‚ùå Cannot generate - limit reached')
      return
    }
    console.log('   ‚úÖ Can generate\n')
    
    // 3. Simulate form submission - create coupon with custom code
    const customCode = 'EKSPORYUK-AZIZ-' + Date.now().toString().slice(-6)
    
    console.log('3Ô∏è‚É£ Creating coupon with custom code:')
    console.log('   Code:', customCode)
    console.log('')
    
    const newCoupon = await prisma.coupon.create({
      data: {
        id: 'coupon-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9),
        code: customCode,
        description: 'Generated from EKSPORYUK by affiliate via form',
        discountType: template.discountType,
        discountValue: template.discountValue,
        isActive: true,
        basedOnCouponId: template.id,
        createdBy: userId,
      }
    })
    
    console.log('‚úÖ COUPON CREATED:')
    console.log('   ID:', newCoupon.id)
    console.log('   Code:', newCoupon.code)
    console.log('   CreatedAt:', newCoupon.createdAt)
    console.log('')
    
    // 4. Verify in database
    const verify = await prisma.coupon.findUnique({
      where: { id: newCoupon.id }
    })
    
    console.log('4Ô∏è‚É£ VERIFICATION:')
    if (verify) {
      console.log('   ‚úÖ Coupon exists in database')
      console.log('   Code:', verify.code)
      console.log('   CreatedBy:', verify.createdBy)
      console.log('   BasedOn:', verify.basedOnCouponId)
    } else {
      console.log('   ‚ùå Coupon not found!')
    }
    console.log('')
    
    // 5. Check updated count
    const newCount = await prisma.coupon.count({
      where: { basedOnCouponId: template.id, createdBy: userId }
    })
    
    console.log('5Ô∏è‚É£ UPDATED GENERATED COUNT:')
    console.log('   Old: ' + currentGenerated)
    console.log('   New: ' + newCount)
    console.log('   Limit: ' + template.maxGeneratePerAffiliate)
    console.log('')
    
    // 6. List all user coupons
    const allUserCoupons = await prisma.coupon.findMany({
      where: { createdBy: userId },
      select: { code: true, basedOnCouponId: true, createdAt: true }
    })
    
    console.log('6Ô∏è‚É£ ALL COUPONS BY USER:')
    console.log('   Total:', allUserCoupons.length)
    allUserCoupons.forEach((c, i) => {
      console.log('   ' + (i+1) + '. ' + c.code)
    })
    
    console.log('')
    console.log('‚úÖ FLOW COMPLETE - SYSTEM WORKING')
    
  } catch (error) {
    console.error('‚ùå Error:', error.message)
    if (error.meta) console.error('Details:', error.meta)
  } finally {
    await prisma.$disconnect()
  }
}

testCompleteFlow()
