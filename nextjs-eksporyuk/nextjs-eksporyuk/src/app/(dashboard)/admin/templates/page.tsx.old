'use client'

import { useState, useEffect } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import { 
  Mail, 
  MessageSquare, 
  Send, 
  Plus, 
  Edit, 
  Trash2, 
  Eye,
  Search,
  ArrowLeft,
  Save,
  X
} from 'lucide-react'

// Types
interface EmailTemplate {
  id: string
  name: string
  category: string
  roleTarget: string
  subject: string
  body: string
  ctaText?: string
  ctaLink?: string
  usageCount: number
  isActive: boolean
  createdAt: string
}

interface WhatsAppTemplate {
  id: string
  name: string
  category: string
  roleTarget: string
  message: string
  ctaText?: string
  ctaLink?: string
  maxLength: number
  usageCount: number
  isActive: boolean
  createdAt: string
}

interface BroadcastCampaign {
  id: string
  name: string
  type: string
  status: string
  targetType: string
  targetRoles?: any
  emailSubject?: string
  whatsappMessage?: string
  totalRecipients: number
  sentCount: number
  failedCount: number
  createdAt: string
}

// Constants
const CATEGORIES = [
  { value: 'ALL', label: 'Semua Kategori' },
  { value: 'SISTEM', label: 'Sistem' },
  { value: 'TRANSAKSIONAL', label: 'Transaksional' },
  { value: 'KOMUNITAS', label: 'Komunitas' },
  { value: 'MARKETING', label: 'Marketing' },
  { value: 'ADMIN', label: 'Admin' },
  { value: 'AFFILIATE', label: 'Affiliate' },
  { value: 'MENTOR', label: 'Mentor' },
  { value: 'SUPPLIER', label: 'Supplier' },
]

const ROLE_TARGETS = [
  { value: 'ALL', label: 'Semua Role' },
  { value: 'ADMIN', label: 'Admin' },
  { value: 'MEMBER', label: 'Member' },
  { value: 'AFFILIATE', label: 'Affiliate' },
  { value: 'MENTOR', label: 'Mentor' },
  { value: 'SUPPLIER', label: 'Supplier' },
]

const AVAILABLE_SHORTCODES = [
  '{name}', '{email}', '{phone}', '{role}',
  '{membership_plan}', '{expiry_date}', '{days_left}',
  '{dashboard_link}', '{profile_link}', '{support_link}',
  '{company_name}', '{year}', '{date}',
]

export default function AdminTemplatesPage() {
  const { data: session, status } = useSession()
  const router = useRouter()

  // Tab navigation
  const [activeView, setActiveView] = useState<'templates' | 'broadcast' | 'form'>('templates')
  const [formType, setFormType] = useState<'email' | 'whatsapp' | 'campaign'>('email')
  const [formMode, setFormMode] = useState<'create' | 'edit' | 'view'>('create')
  const [templateSubTab, setTemplateSubTab] = useState<'email' | 'whatsapp'>('email')
  
  // Data state
  const [emailTemplates, setEmailTemplates] = useState<EmailTemplate[]>([])
  const [whatsappTemplates, setWhatsappTemplates] = useState<WhatsAppTemplate[]>([])
  const [campaigns, setCampaigns] = useState<BroadcastCampaign[]>([])
  const [loading, setLoading] = useState(true)
  
  // Filter state
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedCategory, setSelectedCategory] = useState('ALL')
  const [selectedRoleTarget, setSelectedRoleTarget] = useState('ALL')
  const [statusFilter, setStatusFilter] = useState('ALL')
  const [typeFilter, setTypeFilter] = useState('ALL')
  
  // Current item
  const [currentItem, setCurrentItem] = useState<any>(null)

  // Form states
  const [emailForm, setEmailForm] = useState({
    name: '', category: 'SISTEM', roleTarget: 'ALL',
    subject: '', body: '', ctaText: '', ctaLink: '', isActive: true,
  })

  const [whatsappForm, setWhatsappForm] = useState({
    name: '', category: 'SISTEM', roleTarget: 'ALL',
    message: '', ctaText: '', ctaLink: '', isActive: true,
  })

  const [campaignForm, setCampaignForm] = useState({
    name: '', type: 'EMAIL', targetType: 'ALL', targetRoles: [] as string[],
    emailSubject: '', emailBody: '', emailCtaText: '', emailCtaLink: '',
    whatsappMessage: '', whatsappCtaText: '', whatsappCtaLink: '',
  })

  const [previewAudience, setPreviewAudience] = useState<any>(null)

  // Auth check
  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/auth/login')
    } else if (session?.user?.role !== 'ADMIN') {
      router.push('/dashboard')
    }
  }, [status, session, router])

  // Load data
  useEffect(() => {
    if (session?.user?.role === 'ADMIN' && activeView !== 'form') {
      loadData()
    }
  }, [session, activeView, selectedCategory, selectedRoleTarget, searchQuery, statusFilter, typeFilter])

  const loadData = async () => {
    setLoading(true)
    try {
      if (activeView === 'templates') {
        const params = new URLSearchParams({
          category: selectedCategory,
          roleTarget: selectedRoleTarget,
          search: searchQuery,
        })

        const [emailRes, whatsappRes] = await Promise.all([
          fetch(`/api/admin/templates/email?${params}`),
          fetch(`/api/admin/templates/whatsapp?${params}`),
        ])

        if (emailRes.ok) {
          const data = await emailRes.json()
          setEmailTemplates(data.templates || [])
        }

        if (whatsappRes.ok) {
          const data = await whatsappRes.json()
          setWhatsAppTemplates(data.templates || [])
        }
      } else if (activeView === 'broadcast') {
        const params = new URLSearchParams({
          status: statusFilter,
          type: typeFilter,
        })
        const res = await fetch(`/api/admin/broadcast?${params}`)
        if (res.ok) {
          const data = await res.json()
          setCampaigns(data.campaigns || [])
        }
      }
    } catch (error) {
      console.error('Load data error:', error)
    } finally {
      setLoading(false)
    }
  }

  // Template actions
  const handleCreateTemplate = (type: 'email' | 'whatsapp') => {
    setFormType(type)
    setFormMode('create')
    setCurrentItem(null)
    if (type === 'email') {
      setEmailForm({
        name: '', category: 'SISTEM', roleTarget: 'ALL',
        subject: '', body: '', ctaText: '', ctaLink: '', isActive: true,
      })
    } else {
      setWhatsappForm({
        name: '', category: 'SISTEM', roleTarget: 'ALL',
        message: '', ctaText: '', ctaLink: '', isActive: true,
      })
    }
    setActiveView('form')
  }

  const handleEditTemplate = (template: any, type: 'email' | 'whatsapp') => {
    setFormType(type)
    setFormMode('edit')
    setCurrentItem(template)
    if (type === 'email') {
      setEmailForm({
        name: template.name,
        category: template.category,
        roleTarget: template.roleTarget,
        subject: template.subject,
        body: template.body,
        ctaText: template.ctaText || '',
        ctaLink: template.ctaLink || '',
        isActive: template.isActive,
      })
    } else {
      setWhatsappForm({
        name: template.name,
        category: template.category,
        roleTarget: template.roleTarget,
        message: template.message,
        ctaText: template.ctaText || '',
        ctaLink: template.ctaLink || '',
        isActive: template.isActive,
      })
    }
    setActiveView('form')
  }

  const handleViewTemplate = (template: any, type: 'email' | 'whatsapp') => {
    setFormType(type)
    setFormMode('view')
    setCurrentItem(template)
    if (type === 'email') {
      setEmailForm({
        name: template.name,
        category: template.category,
        roleTarget: template.roleTarget,
        subject: template.subject,
        body: template.body,
        ctaText: template.ctaText || '',
        ctaLink: template.ctaLink || '',
        isActive: template.isActive,
      })
    } else {
      setWhatsappForm({
        name: template.name,
        category: template.category,
        roleTarget: template.roleTarget,
        message: template.message,
        ctaText: template.ctaText || '',
        ctaLink: template.ctaLink || '',
        isActive: template.isActive,
      })
    }
    setActiveView('form')
  }

  const handleDeleteTemplate = async (id: string, type: 'email' | 'whatsapp') => {
    if (!confirm('Hapus template ini?')) return

    try {
      const res = await fetch(`/api/admin/templates/${type}?id=${id}`, {
        method: 'DELETE',
      })
      if (res.ok) {
        await loadData()
      }
    } catch (error) {
      console.error('Delete template error:', error)
    }
  }

  const handleSaveTemplate = async () => {
    try {
      const isEmail = formType === 'email'
      const url = `/api/admin/templates/${formType}`
      const data = isEmail ? emailForm : whatsappForm

      const payload = formMode === 'edit' 
        ? { ...data, id: currentItem.id }
        : data

      const res = await fetch(url, {
        method: formMode === 'create' ? 'POST' : 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })

      if (res.ok) {
        setActiveView('templates')
        await loadData()
      }
    } catch (error) {
      console.error('Save template error:', error)
    }
  }

  // Campaign actions
  const handleCreateCampaign = () => {
    setFormType('campaign')
    setFormMode('create')
    setCurrentItem(null)
    setCampaignForm({
      name: '', type: 'EMAIL', targetType: 'ALL', targetRoles: [],
      emailSubject: '', emailBody: '', emailCtaText: '', emailCtaLink: '',
      whatsappMessage: '', whatsappCtaText: '', whatsappCtaLink: '',
    })
    setPreviewAudience(null)
    setActiveView('form')
  }

  const handleEditCampaign = (campaign: any) => {
    setFormType('campaign')
    setFormMode('edit')
    setCurrentItem(campaign)
    setCampaignForm({
      name: campaign.name,
      type: campaign.type,
      targetType: campaign.targetType,
      targetRoles: campaign.targetRoles || [],
      emailSubject: campaign.emailSubject || '',
      emailBody: campaign.emailBody || '',
      emailCtaText: campaign.emailCtaText || '',
      emailCtaLink: campaign.emailCtaLink || '',
      whatsappMessage: campaign.whatsappMessage || '',
      whatsappCtaText: campaign.whatsappCtaText || '',
      whatsappCtaLink: campaign.whatsappCtaLink || '',
    })
    setPreviewAudience(null)
    setActiveView('form')
  }

  const handleDeleteCampaign = async (id: string) => {
    if (!confirm('Hapus campaign ini?')) return

    try {
      const res = await fetch(`/api/admin/broadcast?id=${id}`, {
        method: 'DELETE',
      })
      if (res.ok) {
        await loadData()
      }
    } catch (error) {
      console.error('Delete campaign error:', error)
    }
  }

  const handleSendCampaign = async (id: string) => {
    if (!confirm('Kirim broadcast sekarang?')) return

    try {
      const res = await fetch('/api/admin/broadcast/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ campaignId: id }),
      })
      
      if (res.ok) {
        const data = await res.json()
        alert(data.message)
        await loadData()
      } else {
        const error = await res.json()
        alert(`Error: ${error.error}`)
      }
    } catch (error) {
      console.error('Send campaign error:', error)
      alert('Gagal mengirim broadcast')
    }
  }

  const handleSaveCampaign = async () => {
    try {
      const url = '/api/admin/broadcast'
      const payload = formMode === 'edit' 
        ? { ...campaignForm, id: currentItem.id }
        : campaignForm

      const res = await fetch(url, {
        method: formMode === 'create' ? 'POST' : 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })

      if (res.ok) {
        setActiveView('broadcast')
        await loadData()
      }
    } catch (error) {
      console.error('Save campaign error:', error)
    }
  }

  const handlePreviewAudience = async () => {
    try {
      const res = await fetch('/api/admin/broadcast/preview-audience', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          targetType: campaignForm.targetType,
          targetRoles: campaignForm.targetRoles,
        }),
      })
      if (res.ok) {
        const data = await res.json()
        setPreviewAudience(data.preview)
      }
    } catch (error) {
      console.error('Preview audience error:', error)
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'DRAFT': return 'bg-gray-100 text-gray-800'
      case 'SCHEDULED': return 'bg-blue-100 text-blue-800'
      case 'SENDING': return 'bg-yellow-100 text-yellow-800'
      case 'COMPLETED': return 'bg-green-100 text-green-800'
      case 'FAILED': return 'bg-red-100 text-red-800'
      default: return 'bg-gray-100 text-gray-800'
    }
  }

  if (status === 'loading' || !session) {
    return (
      <div className="flex items-center justify-center h-screen">
        <p className="text-gray-500">Loading...</p>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-white border-b border-gray-200">
        <div className="px-6 py-4">
          <h1 className="text-2xl font-bold text-gray-900">Template & Broadcast</h1>
          <p className="text-sm text-gray-600 mt-1">
            Kelola template email, WhatsApp, dan broadcast campaign
          </p>
        </div>

        {/* Main Navigation */}
        {activeView !== 'form' && (
          <div className="px-6">
            <nav className="flex space-x-4 border-b border-gray-200">
              <button
                onClick={() => setActiveView('templates')}
                className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                  activeView === 'templates'
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <Mail className="w-4 h-4 inline-block mr-2" />
                Templates
              </button>
              <button
                onClick={() => setActiveView('broadcast')}
                className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                  activeView === 'broadcast'
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700'
                }`}
              >
                <Send className="w-4 h-4 inline-block mr-2" />
                Broadcast
              </button>
            </nav>
          </div>
        )}
      </div>

      {/* Content */}
      <div className="p-6">
        {/* Templates View */}
        {activeView === 'templates' && (
          <div className="bg-white rounded-lg shadow">
            {/* Template Sub Navigation */}
            <div className="border-b border-gray-200 px-6">
              <nav className="flex space-x-4">
                <button
                  onClick={() => setTemplateSubTab('email')}
                  className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                    templateSubTab === 'email'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  <Mail className="w-4 h-4 inline-block mr-2" />
                  Email
                </button>
                <button
                  onClick={() => setTemplateSubTab('whatsapp')}
                  className={`px-4 py-3 font-medium text-sm border-b-2 transition-colors ${
                    templateSubTab === 'whatsapp'
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700'
                  }`}
                >
                  <MessageSquare className="w-4 h-4 inline-block mr-2" />
                  WhatsApp
                </button>
              </nav>
            </div>

            {/* Filters & Actions */}
            <div className="p-6 border-b border-gray-200">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                  <input
                    type="text"
                    placeholder="Cari template..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                <select
                  value={selectedCategory}
                  onChange={(e) => setSelectedCategory(e.target.value)}
                  className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  {CATEGORIES.map((cat) => (
                    <option key={cat.value} value={cat.value}>
                      {cat.label}
                    </option>
                  ))}
                </select>

                <select
                  value={selectedRoleTarget}
                  onChange={(e) => setSelectedRoleTarget(e.target.value)}
                  className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  {ROLE_TARGETS.map((role) => (
                    <option key={role.value} value={role.value}>
                      {role.label}
                    </option>
                  ))}
                </select>

                <button
                  onClick={() => handleCreateTemplate(templateSubTab)}
                  className="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <Plus className="w-4 h-4" />
                  Tambah
                </button>
              </div>
            </div>

            {/* Template List */}
            <div className="p-6">
              {loading ? (
                <div className="text-center py-12">
                  <p className="text-gray-500">Loading...</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {(templateSubTab === 'email' ? emailTemplates : whatsappTemplates).length === 0 ? (
                    <div className="text-center py-12">
                      <p className="text-gray-500">Tidak ada template</p>
                      <button
                        onClick={() => handleCreateTemplate(templateSubTab)}
                        className="mt-4 text-blue-600 hover:text-blue-700"
                      >
                        Buat template pertama
                      </button>
                    </div>
                  ) : (
                    (templateSubTab === 'email' ? emailTemplates : whatsappTemplates).map((template: any) => (
                      <div
                        key={template.id}
                        className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-3 mb-2">
                              <h3 className="text-lg font-semibold text-gray-900">
                                {template.name}
                              </h3>
                              <span className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded">
                                {template.category}
                              </span>
                              <span className="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded">
                                {template.roleTarget}
                              </span>
                              {!template.isActive && (
                                <span className="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded">
                                  Nonaktif
                                </span>
                              )}
                            </div>
                            {templateSubTab === 'email' && (
                              <p className="text-sm text-gray-600 mb-1">
                                <strong>Subject:</strong> {template.subject}
                              </p>
                            )}
                            <p className="text-sm text-gray-500 line-clamp-2">
                              {templateSubTab === 'email' ? template.body : template.message}
                            </p>
                            <div className="flex items-center gap-4 mt-3 text-xs text-gray-500">
                              <span>Digunakan: {template.usageCount}x</span>
                              <span>
                                Dibuat: {new Date(template.createdAt).toLocaleDateString('id-ID')}
                              </span>
                            </div>
                          </div>

                          <div className="flex items-center gap-2 ml-4">
                            <button
                              onClick={() => handleViewTemplate(template, templateSubTab)}
                              className="p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                              title="Preview"
                            >
                              <Eye className="w-4 h-4" />
                            </button>
                            <button
                              onClick={() => handleEditTemplate(template, templateSubTab)}
                              className="p-2 text-gray-600 hover:text-yellow-600 hover:bg-yellow-50 rounded-lg transition-colors"
                              title="Edit"
                            >
                              <Edit className="w-4 h-4" />
                            </button>
                            <button
                              onClick={() => handleDeleteTemplate(template.id, templateSubTab)}
                              className="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                              title="Hapus"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Broadcast View */}
        {activeView === 'broadcast' && (
          <div className="bg-white rounded-lg shadow">
            {/* Filters & Actions */}
            <div className="p-6 border-b border-gray-200">
              <div className="flex flex-wrap items-center gap-4">
                <select
                  value={statusFilter}
                  onChange={(e) => setStatusFilter(e.target.value)}
                  className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="ALL">Semua Status</option>
                  <option value="DRAFT">Draft</option>
                  <option value="SCHEDULED">Scheduled</option>
                  <option value="SENDING">Sending</option>
                  <option value="COMPLETED">Completed</option>
                  <option value="FAILED">Failed</option>
                </select>

                <select
                  value={typeFilter}
                  onChange={(e) => setTypeFilter(e.target.value)}
                  className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="ALL">Semua Tipe</option>
                  <option value="EMAIL">Email</option>
                  <option value="WHATSAPP">WhatsApp</option>
                  <option value="BOTH">Email + WhatsApp</option>
                </select>

                <button
                  onClick={handleCreateCampaign}
                  className="ml-auto flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  <Plus className="w-4 h-4" />
                  Campaign Baru
                </button>
              </div>
            </div>

            {/* Campaign List */}
            <div className="p-6">
              {loading ? (
                <div className="text-center py-12">
                  <p className="text-gray-500">Loading...</p>
                </div>
              ) : campaigns.length === 0 ? (
                <div className="text-center py-12 border border-gray-200 rounded-lg">
                  <Send className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                  <p className="text-gray-500 mb-4">Belum ada campaign</p>
                  <button
                    onClick={handleCreateCampaign}
                    className="text-blue-600 hover:text-blue-700"
                  >
                    Buat campaign pertama
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  {campaigns.map((campaign) => (
                    <div
                      key={campaign.id}
                      className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <h3 className="text-lg font-semibold text-gray-900">
                              {campaign.name}
                            </h3>
                            <span className={`px-2 py-1 text-xs font-medium rounded ${getStatusColor(campaign.status)}`}>
                              {campaign.status}
                            </span>
                            <span className="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded">
                              {campaign.type}
                            </span>
                            <span className="px-2 py-1 text-xs font-medium bg-indigo-100 text-indigo-800 rounded">
                              {campaign.targetType}
                            </span>
                          </div>
                          
                          {campaign.emailSubject && (
                            <p className="text-sm text-gray-600 mb-1">
                              <strong>Subject:</strong> {campaign.emailSubject}
                            </p>
                          )}
                          
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3 text-xs text-gray-500">
                            <div>
                              <span className="font-medium">Target:</span> {campaign.totalRecipients}
                            </div>
                            <div>
                              <span className="font-medium">Sent:</span> {campaign.sentCount}
                            </div>
                            <div>
                              <span className="font-medium">Failed:</span> {campaign.failedCount}
                            </div>
                            <div>
                              <span className="font-medium">Created:</span> {new Date(campaign.createdAt).toLocaleDateString('id-ID')}
                            </div>
                          </div>
                        </div>

                        <div className="flex items-center gap-2 ml-4">
                          {campaign.status === 'DRAFT' && (
                            <>
                              <button
                                onClick={() => handleSendCampaign(campaign.id)}
                                className="p-2 text-gray-600 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                title="Kirim"
                              >
                                <Send className="w-4 h-4" />
                              </button>
                              <button
                                onClick={() => handleEditCampaign(campaign)}
                                className="p-2 text-gray-600 hover:text-yellow-600 hover:bg-yellow-50 rounded-lg transition-colors"
                                title="Edit"
                              >
                                <Edit className="w-4 h-4" />
                              </button>
                            </>
                          )}
                          {campaign.status !== 'SENDING' && (
                            <button
                              onClick={() => handleDeleteCampaign(campaign.id)}
                              className="p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                              title="Hapus"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Form View */}
        {activeView === 'form' && (
          <div className="bg-white rounded-lg shadow">
            {/* Form Header */}
            <div className="p-6 border-b border-gray-200 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button
                  onClick={() => setActiveView(formType === 'campaign' ? 'broadcast' : 'templates')}
                  className="p-2 hover:bg-gray-100 rounded-lg"
                >
                  <ArrowLeft className="w-5 h-5" />
                </button>
                <div>
                  <h2 className="text-xl font-bold text-gray-900">
                    {formMode === 'create' ? 'Buat' : formMode === 'edit' ? 'Edit' : 'Preview'}{' '}
                    {formType === 'email' ? 'Email Template' : formType === 'whatsapp' ? 'WhatsApp Template' : 'Campaign'}
                  </h2>
                  {formMode === 'view' && (
                    <p className="text-sm text-gray-600 mt-1">Mode preview - tidak bisa edit</p>
                  )}
                </div>
              </div>
              {formMode !== 'view' && (
                <div className="flex gap-2">
                  <button
                    onClick={() => setActiveView(formType === 'campaign' ? 'broadcast' : 'templates')}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    <X className="w-4 h-4 inline-block mr-2" />
                    Batal
                  </button>
                  <button
                    onClick={formType === 'campaign' ? handleSaveCampaign : handleSaveTemplate}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    <Save className="w-4 h-4 inline-block mr-2" />
                    Simpan
                  </button>
                </div>
              )}
            </div>

            {/* Form Content with Live Preview */}
            <div className="p-6">
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Left: Form */}
                <div className="space-y-4">
                  {/* Email Template Form */}
                  {formType === 'email' && (
                    <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Nama Template *</label>
                    <input
                      type="text"
                      value={emailForm.name}
                      onChange={(e) => setEmailForm({ ...emailForm, name: e.target.value })}
                      disabled={formMode === 'view'}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      required
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Kategori *</label>
                      <select
                        value={emailForm.category}
                        onChange={(e) => setEmailForm({ ...emailForm, category: e.target.value })}
                        disabled={formMode === 'view'}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      >
                        {CATEGORIES.filter(c => c.value !== 'ALL').map((cat) => (
                          <option key={cat.value} value={cat.value}>{cat.label}</option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Target Role *</label>
                      <select
                        value={emailForm.roleTarget}
                        onChange={(e) => setEmailForm({ ...emailForm, roleTarget: e.target.value })}
                        disabled={formMode === 'view'}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      >
                        {ROLE_TARGETS.map((role) => (
                          <option key={role.value} value={role.value}>{role.label}</option>
                        ))}
                      </select>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Subject *</label>
                    <input
                      type="text"
                      value={emailForm.subject}
                      onChange={(e) => setEmailForm({ ...emailForm, subject: e.target.value })}
                      disabled={formMode === 'view'}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Body *</label>
                    <textarea
                      value={emailForm.body}
                      onChange={(e) => setEmailForm({ ...emailForm, body: e.target.value })}
                      disabled={formMode === 'view'}
                      rows={10}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      required
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      Shortcodes: {AVAILABLE_SHORTCODES.join(', ')}
                    </p>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">CTA Text</label>
                      <input
                        type="text"
                        value={emailForm.ctaText}
                        onChange={(e) => setEmailForm({ ...emailForm, ctaText: e.target.value })}
                        disabled={formMode === 'view'}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">CTA Link</label>
                      <input
                        type="url"
                        value={emailForm.ctaLink}
                        onChange={(e) => setEmailForm({ ...emailForm, ctaLink: e.target.value })}
                        disabled={formMode === 'view'}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      />
                    </div>
                  </div>

                  {formMode !== 'view' && (
                    <div>
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={emailForm.isActive}
                          onChange={(e) => setEmailForm({ ...emailForm, isActive: e.target.checked })}
                          className="rounded"
                        />
                        <span className="text-sm font-medium text-gray-700">Template Aktif</span>
                      </label>
                    </div>
                  )}
                </div>
              )}

              {/* WhatsApp Template Form */}
              {formType === 'whatsapp' && (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Nama Template *</label>
                    <input
                      type="text"
                      value={whatsappForm.name}
                      onChange={(e) => setWhatsappForm({ ...whatsappForm, name: e.target.value })}
                      disabled={formMode === 'view'}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      required
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Kategori *</label>
                      <select
                        value={whatsappForm.category}
                        onChange={(e) => setWhatsappForm({ ...whatsappForm, category: e.target.value })}
                        disabled={formMode === 'view'}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      >
                        {CATEGORIES.filter(c => c.value !== 'ALL').map((cat) => (
                          <option key={cat.value} value={cat.value}>{cat.label}</option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Target Role *</label>
                      <select
                        value={whatsappForm.roleTarget}
                        onChange={(e) => setWhatsappForm({ ...whatsappForm, roleTarget: e.target.value })}
                        disabled={formMode === 'view'}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      >
                        {ROLE_TARGETS.map((role) => (
                          <option key={role.value} value={role.value}>{role.label}</option>
                        ))}
                      </select>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Message *</label>
                    <textarea
                      value={whatsappForm.message}
                      onChange={(e) => setWhatsappForm({ ...whatsappForm, message: e.target.value })}
                      disabled={formMode === 'view'}
                      rows={8}
                      maxLength={1024}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      required
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      {whatsappForm.message.length}/1024 karakter
                    </p>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">CTA Text</label>
                      <input
                        type="text"
                        value={whatsappForm.ctaText}
                        onChange={(e) => setWhatsappForm({ ...whatsappForm, ctaText: e.target.value })}
                        disabled={formMode === 'view'}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">CTA Link</label>
                      <input
                        type="url"
                        value={whatsappForm.ctaLink}
                        onChange={(e) => setWhatsappForm({ ...whatsappForm, ctaLink: e.target.value })}
                        disabled={formMode === 'view'}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-gray-100"
                      />
                    </div>
                  </div>

                  {formMode !== 'view' && (
                    <div>
                      <label className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={whatsappForm.isActive}
                          onChange={(e) => setWhatsappForm({ ...whatsappForm, isActive: e.target.checked })}
                          className="rounded"
                        />
                        <span className="text-sm font-medium text-gray-700">Template Aktif</span>
                      </label>
                    </div>
                  )}
                </div>
              )}

              {/* Campaign Form */}
              {formType === 'campaign' && (
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Nama Campaign *</label>
                    <input
                      type="text"
                      value={campaignForm.name}
                      onChange={(e) => setCampaignForm({ ...campaignForm, name: e.target.value })}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      required
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Tipe *</label>
                      <select
                        value={campaignForm.type}
                        onChange={(e) => setCampaignForm({ ...campaignForm, type: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="EMAIL">Email</option>
                        <option value="WHATSAPP">WhatsApp</option>
                        <option value="BOTH">Email + WhatsApp</option>
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Target Audience *</label>
                      <select
                        value={campaignForm.targetType}
                        onChange={(e) => setCampaignForm({ ...campaignForm, targetType: e.target.value })}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="ALL">Semua User</option>
                        <option value="BY_ROLE">By Role</option>
                        <option value="BY_MEMBERSHIP">By Membership</option>
                        <option value="BY_GROUP">By Group</option>
                        <option value="BY_COURSE">By Course</option>
                      </select>
                    </div>
                  </div>

                  {campaignForm.targetType === 'BY_ROLE' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Pilih Roles *</label>
                      <div className="grid grid-cols-3 gap-2">
                        {['ADMIN', 'MEMBER_FREE', 'MEMBER_PRO', 'AFFILIATE', 'MENTOR', 'SUPPLIER'].map((role) => (
                          <label key={role} className="flex items-center gap-2">
                            <input
                              type="checkbox"
                              checked={campaignForm.targetRoles.includes(role)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setCampaignForm({ 
                                    ...campaignForm, 
                                    targetRoles: [...campaignForm.targetRoles, role] 
                                  })
                                } else {
                                  setCampaignForm({ 
                                    ...campaignForm, 
                                    targetRoles: campaignForm.targetRoles.filter(r => r !== role) 
                                  })
                                }
                              }}
                              className="rounded"
                            />
                            <span className="text-sm">{role}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                  )}

                  <div>
                    <button
                      type="button"
                      onClick={handlePreviewAudience}
                      className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"
                    >
                      Preview Target Audience
                    </button>
                    {previewAudience && (
                      <div className="mt-2 p-4 bg-blue-50 rounded-lg">
                        <p className="text-sm font-medium text-gray-900 mb-1">
                          Total Target: {previewAudience.totalUsers} users
                        </p>
                        <p className="text-xs text-gray-600">
                          Email: {previewAudience.emailEnabledUsers} | WhatsApp: {previewAudience.whatsappEnabledUsers}
                        </p>
                      </div>
                    )}
                  </div>

                  {(campaignForm.type === 'EMAIL' || campaignForm.type === 'BOTH') && (
                    <div className="border-t pt-6">
                      <h3 className="text-lg font-semibold mb-4">Email Content</h3>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Subject *</label>
                          <input
                            type="text"
                            value={campaignForm.emailSubject}
                            onChange={(e) => setCampaignForm({ ...campaignForm, emailSubject: e.target.value })}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Body *</label>
                          <textarea
                            value={campaignForm.emailBody}
                            onChange={(e) => setCampaignForm({ ...campaignForm, emailBody: e.target.value })}
                            rows={8}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                          <p className="text-xs text-gray-500 mt-1">
                            Shortcodes: {AVAILABLE_SHORTCODES.join(', ')}
                          </p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">CTA Text</label>
                            <input
                              type="text"
                              value={campaignForm.emailCtaText}
                              onChange={(e) => setCampaignForm({ ...campaignForm, emailCtaText: e.target.value })}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">CTA Link</label>
                            <input
                              type="url"
                              value={campaignForm.emailCtaLink}
                              onChange={(e) => setCampaignForm({ ...campaignForm, emailCtaLink: e.target.value })}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {(campaignForm.type === 'WHATSAPP' || campaignForm.type === 'BOTH') && (
                    <div className="border-t pt-6">
                      <h3 className="text-lg font-semibold mb-4">WhatsApp Content</h3>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Message *</label>
                          <textarea
                            value={campaignForm.whatsappMessage}
                            onChange={(e) => setCampaignForm({ ...campaignForm, whatsappMessage: e.target.value })}
                            rows={6}
                            maxLength={1024}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          />
                          <p className="text-xs text-gray-500 mt-1">
                            {campaignForm.whatsappMessage.length}/1024 karakter
                          </p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">CTA Text</label>
                            <input
                              type="text"
                              value={campaignForm.whatsappCtaText}
                              onChange={(e) => setCampaignForm({ ...campaignForm, whatsappCtaText: e.target.value })}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">CTA Link</label>
                            <input
                              type="url"
                              value={campaignForm.whatsappCtaLink}
                              onChange={(e) => setCampaignForm({ ...campaignForm, whatsappCtaLink: e.target.value })}
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
