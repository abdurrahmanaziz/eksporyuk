'use client'

import { useState, useEffect, useMemo } from 'react'
import { useSession } from 'next-auth/react'
import { redirect } from 'next/navigation'
import toast from 'react-hot-toast'
import { 
  Copy, Check, Share2, ExternalLink, TrendingUp, Users, DollarSign, 
  Archive, ArchiveRestore, Link2, Package, BookOpen, Crown, Truck,
  Search, RefreshCw, Plus, Eye, EyeOff
} from 'lucide-react'

// Types
interface AffiliateLink {
  id: string
  code: string
  url: string
  linkType?: string
  targetType?: string
  targetName?: string
  clicks: number
  conversions: number
  revenue: number
  isArchived: boolean
  createdAt: string
  membership?: { id: string; name: string; slug: string }
  product?: { id: string; name: string; slug: string }
  course?: { id: string; title: string }
}

interface Coupon {
  id: string
  code: string
  description: string | null
  discountType: string
  discountValue: number
  isOwnCoupon: boolean
  source: 'affiliate' | 'admin'
}

// Tab Types
type MainTabType = 'list' | 'create'
type FilterTabType = 'all' | 'membership' | 'product' | 'course' | 'supplier'

// Main Tabs (List vs Create)
const MAIN_TABS: { key: MainTabType; label: string; icon: any }[] = [
  { key: 'list', label: 'Semua Link', icon: Link2 },
  { key: 'create', label: 'Buat Link Baru', icon: Plus },
]

// Filter Tabs (untuk filter di list)
const FILTER_TABS: { key: FilterTabType; label: string; icon: any; color: string }[] = [
  { key: 'all', label: 'Semua', icon: Link2, color: 'text-gray-600' },
  { key: 'membership', label: 'Membership', icon: Crown, color: 'text-amber-600' },
  { key: 'product', label: 'Produk', icon: Package, color: 'text-blue-600' },
  { key: 'course', label: 'Kelas', icon: BookOpen, color: 'text-green-600' },
  { key: 'supplier', label: 'Supplier', icon: Truck, color: 'text-purple-600' },
]

export default function AffiliateLinksPage() {
  const { data: session, status } = useSession()
  
  // State
  const [links, setLinks] = useState<AffiliateLink[]>([])
  const [loading, setLoading] = useState(true)
  const [copiedId, setCopiedId] = useState<string | null>(null)
  const [generating, setGenerating] = useState(false)
  const [showArchived, setShowArchived] = useState(false)
  const [archivingId, setArchivingId] = useState<string | null>(null)
  const [searchQuery, setSearchQuery] = useState('')
  const [mainTab, setMainTab] = useState<MainTabType>('list')
  const [filterTab, setFilterTab] = useState<FilterTabType>('all')
  
  // Form state
  const [selectedLinkType, setSelectedLinkType] = useState<'CHECKOUT' | 'SALESPAGE_INTERNAL' | 'SALESPAGE_EXTERNAL'>('CHECKOUT')
  const [selectedTargetType, setSelectedTargetType] = useState<'membership' | 'product' | 'course'>('membership')
  const [selectedTargetId, setSelectedTargetId] = useState('')
  const [selectedCouponCode, setSelectedCouponCode] = useState('')
  
  // Data state
  const [memberships, setMemberships] = useState<any[]>([])
  const [products, setProducts] = useState<any[]>([])
  const [courses, setCourses] = useState<any[]>([])
  const [coupons, setCoupons] = useState<Coupon[]>([])

  useEffect(() => {
    if (status === 'unauthenticated') {
      redirect('/auth/login')
    }

    if (status === 'authenticated') {
      fetchAllData()
    }
  }, [status, showArchived])

  const fetchAllData = async () => {
    setLoading(true)
    await Promise.all([
      fetchLinks(),
      fetchMemberships(),
      fetchProducts(),
      fetchCourses(),
      fetchCoupons()
    ])
    setLoading(false)
  }

  const fetchLinks = async () => {
    try {
      const url = showArchived 
        ? '/api/affiliate/links?archived=true' 
        : '/api/affiliate/links'
      const response = await fetch(url)
      const data = await response.json()
      
      if (data.links) {
        // Enrich links with target info
        const enrichedLinks = data.links.map((link: any) => ({
          ...link,
          targetType: link.membership ? 'membership' : link.product ? 'product' : link.course ? 'course' : 'general',
          targetName: link.membership?.name || link.product?.name || link.course?.title || 'Semua Produk'
        }))
        setLinks(enrichedLinks)
      }
    } catch (error) {
      console.error('Error fetching links:', error)
      toast.error('Gagal memuat link')
    }
  }

  const fetchMemberships = async () => {
    try {
      const response = await fetch('/api/memberships/packages')
      const data = await response.json()
      if (data.packages) setMemberships(data.packages)
    } catch (error) {
      console.error('Error fetching memberships:', error)
    }
  }

  const fetchProducts = async () => {
    try {
      const response = await fetch('/api/products')
      const data = await response.json()
      if (data.products) setProducts(data.products)
    } catch (error) {
      console.error('Error fetching products:', error)
    }
  }

  const fetchCourses = async () => {
    try {
      const response = await fetch('/api/courses?includeAll=true')
      const data = await response.json()
      if (data.courses) setCourses(data.courses.filter((c: any) => c.isPublished))
    } catch (error) {
      console.error('Error fetching courses:', error)
    }
  }

  const fetchCoupons = async () => {
    try {
      const response = await fetch('/api/affiliate/coupons/all')
      const data = await response.json()
      if (data.coupons) setCoupons(data.coupons)
    } catch (error) {
      console.error('Error fetching coupons:', error)
    }
  }

  // Filter links based on filter tab and search
  const filteredLinks = useMemo(() => {
    let filtered = links

    // Filter by filter tab
    if (filterTab !== 'all') {
      filtered = filtered.filter(link => {
        if (filterTab === 'membership') return link.membership || link.targetType === 'membership'
        if (filterTab === 'product') return link.product || link.targetType === 'product'
        if (filterTab === 'course') return link.course || link.targetType === 'course'
        if (filterTab === 'supplier') return link.targetType === 'supplier'
        return true
      })
    }

    // Filter by search
    if (searchQuery) {
      const query = searchQuery.toLowerCase()
      filtered = filtered.filter(link => 
        link.code.toLowerCase().includes(query) ||
        link.url.toLowerCase().includes(query) ||
        link.targetName?.toLowerCase().includes(query)
      )
    }

    return filtered
  }, [links, filterTab, searchQuery])

  // Stats per filter tab
  const tabStats = useMemo(() => {
    const stats: Record<FilterTabType, { count: number; clicks: number; conversions: number }> = {
      all: { count: links.length, clicks: 0, conversions: 0 },
      membership: { count: 0, clicks: 0, conversions: 0 },
      product: { count: 0, clicks: 0, conversions: 0 },
      course: { count: 0, clicks: 0, conversions: 0 },
      supplier: { count: 0, clicks: 0, conversions: 0 },
    }

    links.forEach(link => {
      stats.all.clicks += link.clicks
      stats.all.conversions += link.conversions

      if (link.membership || link.targetType === 'membership') {
        stats.membership.count++
        stats.membership.clicks += link.clicks
        stats.membership.conversions += link.conversions
      } else if (link.product || link.targetType === 'product') {
        stats.product.count++
        stats.product.clicks += link.clicks
        stats.product.conversions += link.conversions
      } else if (link.course || link.targetType === 'course') {
        stats.course.count++
        stats.course.clicks += link.clicks
        stats.course.conversions += link.conversions
      } else if (link.targetType === 'supplier') {
        stats.supplier.count++
        stats.supplier.clicks += link.clicks
        stats.supplier.conversions += link.conversions
      }
    })

    return stats
  }, [links])

  const generateNewLink = async () => {
    if (!selectedCouponCode) {
      toast.error('Pilih kupon terlebih dahulu')
      return
    }

    setGenerating(true)
    try {
      const payload = {
        linkType: selectedLinkType,
        targetType: selectedTargetType,
        targetId: selectedTargetId || null,
        couponCode: selectedCouponCode,
      }
      
      console.log('üöÄ Sending generate link request:', payload)
      
      const response = await fetch('/api/affiliate/links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })
      
      console.log('üì° Response status:', response.status)
      
      const data = await response.json()
      
      console.log('üì¶ Response data:', data)
      
      if (data.link) {
        await fetchLinks()
        setMainTab('list')
        resetForm()
        toast.success('Link berhasil dibuat!')
        
        // Auto copy
        navigator.clipboard.writeText(data.link.url)
        toast.success('Link sudah dicopy ke clipboard!')
      } else if (data.error) {
        console.error('‚ùå API Error:', data.error)
        toast.error(data.error)
      }
    } catch (error) {
      console.error('‚ùå Error generating link:', error)
      toast.error('Gagal membuat link')
    } finally {
      setGenerating(false)
    }
  }

  const resetForm = () => {
    setSelectedLinkType('CHECKOUT')
    setSelectedTargetType('membership')
    setSelectedTargetId('')
    setSelectedCouponCode('')
  }

  const copyToClipboard = async (url: string, id: string) => {
    try {
      await navigator.clipboard.writeText(url)
      setCopiedId(id)
      toast.success('Link dicopy!')
      setTimeout(() => setCopiedId(null), 2000)
    } catch (error) {
      toast.error('Gagal copy link')
    }
  }

  const toggleArchiveLink = async (linkId: string, currentStatus: boolean) => {
    setArchivingId(linkId)
    try {
      const response = await fetch(`/api/affiliate/links/${linkId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isArchived: !currentStatus }),
      })
      
      if (response.ok) {
        await fetchLinks()
        toast.success(currentStatus ? 'Link dipulihkan' : 'Link diarsipkan')
      }
    } catch (error) {
      toast.error('Gagal mengubah status link')
    } finally {
      setArchivingId(null)
    }
  }

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0,
    }).format(amount)
  }

  const getLinkTypeBadge = (linkType?: string) => {
    const badges: Record<string, { label: string; color: string }> = {
      SALESPAGE_INTERNAL: { label: 'üîó Salespage', color: 'bg-blue-100 text-blue-700' },
      CHECKOUT: { label: 'üí≥ Checkout', color: 'bg-green-100 text-green-700' },
      SALESPAGE_EXTERNAL: { label: 'üîÑ Alternatif', color: 'bg-purple-100 text-purple-700' },
    }
    const badge = badges[linkType || 'CHECKOUT'] || badges.CHECKOUT
    return (
      <span className={`px-2 py-0.5 text-xs font-medium rounded ${badge.color}`}>
        {badge.label}
      </span>
    )
  }

  const getTargetTypeBadge = (link: AffiliateLink) => {
    if (link.membership) {
      return <span className="px-2 py-0.5 text-xs font-medium rounded bg-amber-100 text-amber-700">üëë {link.membership.name}</span>
    }
    if (link.product) {
      return <span className="px-2 py-0.5 text-xs font-medium rounded bg-blue-100 text-blue-700">üì¶ {link.product.name}</span>
    }
    if (link.course) {
      return <span className="px-2 py-0.5 text-xs font-medium rounded bg-green-100 text-green-700">üìö {link.course.title}</span>
    }
    return <span className="px-2 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-700">üåê Semua Produk</span>
  }

  // Calculate totals for current filtered links
  const totalClicks = filteredLinks.reduce((sum, link) => sum + link.clicks, 0)
  const totalConversions = filteredLinks.reduce((sum, link) => sum + link.conversions, 0)
  const totalRevenue = filteredLinks.reduce((sum, link) => sum + link.revenue, 0)
  const conversionRate = totalClicks > 0 ? (totalConversions / totalClicks) * 100 : 0

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-orange-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Memuat data...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50 py-6 px-4 sm:px-6 lg:px-8">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-6">
          <h1 className="text-2xl font-bold text-gray-900 mb-1">Link Affiliate</h1>
          <p className="text-gray-600 text-sm">Kelola semua link affiliate untuk membership, produk, kelas, dan supplier</p>
        </div>

        {/* Stats Cards */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div className="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
            <div className="flex items-center justify-between mb-1">
              <span className="text-gray-500 text-xs font-medium">Total Klik</span>
              <TrendingUp className="h-4 w-4 text-blue-500" />
            </div>
            <p className="text-2xl font-bold text-gray-900">{totalClicks.toLocaleString()}</p>
          </div>

          <div className="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
            <div className="flex items-center justify-between mb-1">
              <span className="text-gray-500 text-xs font-medium">Konversi</span>
              <Users className="h-4 w-4 text-green-500" />
            </div>
            <p className="text-2xl font-bold text-gray-900">{totalConversions}</p>
          </div>

          <div className="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
            <div className="flex items-center justify-between mb-1">
              <span className="text-gray-500 text-xs font-medium">Rate</span>
              <Share2 className="h-4 w-4 text-purple-500" />
            </div>
            <p className="text-2xl font-bold text-gray-900">{conversionRate.toFixed(1)}%</p>
          </div>

          <div className="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
            <div className="flex items-center justify-between mb-1">
              <span className="text-gray-500 text-xs font-medium">Total Komisi</span>
              <DollarSign className="h-4 w-4 text-orange-500" />
            </div>
            <p className="text-xl font-bold text-orange-600">{formatCurrency(totalRevenue)}</p>
          </div>
        </div>

        {/* Main Tabs */}
        <div className="bg-white border border-gray-200 rounded-xl shadow-sm mb-6">
          <div className="border-b border-gray-200">
            <div className="flex">
              {MAIN_TABS.map((tab) => {
                const Icon = tab.icon
                const isActive = mainTab === tab.key
                
                return (
                  <button
                    key={tab.key}
                    onClick={() => setMainTab(tab.key)}
                    className={`flex items-center gap-2 px-6 py-4 border-b-2 transition-colors ${
                      isActive
                        ? 'border-orange-500 text-orange-600 bg-orange-50/50'
                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                    }`}
                  >
                    <Icon className={`h-5 w-5 ${isActive ? 'text-orange-500' : 'text-gray-400'}`} />
                    <span className="font-semibold">{tab.label}</span>
                  </button>
                )
              })}
            </div>
          </div>

          {/* Tab Content */}
          <div className="p-6">
            {mainTab === 'list' ? (
              // LIST TAB CONTENT
              <div className="space-y-6">
                {/* Filter Tabs */}
                <div className="border-b border-gray-200">
                  <div className="flex overflow-x-auto scrollbar-hide -mb-px">
                    {FILTER_TABS.map((tab) => {
                      const Icon = tab.icon
                      const stat = tabStats[tab.key]
                      const isActive = filterTab === tab.key
                      
                      return (
                        <button
                          key={tab.key}
                          onClick={() => setFilterTab(tab.key)}
                          className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-colors whitespace-nowrap ${
                            isActive
                              ? 'border-orange-500 text-orange-600 bg-orange-50/30'
                              : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                          }`}
                        >
                          <Icon className={`h-4 w-4 ${isActive ? 'text-orange-500' : tab.color}`} />
                          <span className="font-medium text-sm">{tab.label}</span>
                          <span className={`px-1.5 py-0.5 text-xs rounded-full ${
                            isActive ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-600'
                          }`}>
                            {stat.count}
                          </span>
                        </button>
                      )
                    })}
                  </div>
                </div>

                {/* Search & Actions */}
                <div className="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
                  <div className="relative flex-1 max-w-md">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <input
                      type="text"
                      placeholder="Cari link..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    />
                  </div>
                  
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => setShowArchived(!showArchived)}
                      className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        showArchived
                          ? 'bg-gray-600 text-white'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      {showArchived ? <Eye className="h-4 w-4" /> : <EyeOff className="h-4 w-4" />}
                      {showArchived ? 'Aktif' : 'Arsip'}
                    </button>
                    
                    <button
                      onClick={fetchAllData}
                      className="p-2 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors"
                      title="Refresh"
                    >
                      <RefreshCw className="h-4 w-4" />
                    </button>
                  </div>
                </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Kode & Target</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">URL</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Klik</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Konversi</th>
                  <th className="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Komisi</th>
                  <th className="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Aksi</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {filteredLinks.length === 0 ? (
                  <tr>
                    <td colSpan={6} className="px-4 py-12 text-center">
                      <Link2 className="h-10 w-10 mx-auto mb-3 text-gray-300" />
                      <p className="text-gray-600 font-medium mb-1">
                        {searchQuery ? 'Tidak ada link yang cocok' : 'Belum ada link'}
                      </p>
                      <p className="text-sm text-gray-500">
                        {searchQuery ? 'Coba kata kunci lain' : 'Klik "Generate Link" untuk membuat link baru'}
                      </p>
                    </td>
                  </tr>
                ) : (
                  filteredLinks.map((link) => (
                    <tr key={link.id} className={`hover:bg-gray-50 transition-colors ${link.isArchived ? 'bg-gray-50/50' : ''}`}>
                      <td className="px-4 py-3">
                        <div className="flex flex-col gap-1.5">
                          <span className="font-mono text-sm font-semibold text-orange-600">{link.code}</span>
                          <div className="flex flex-wrap items-center gap-1.5">
                            {getLinkTypeBadge(link.linkType)}
                            {getTargetTypeBadge(link)}
                            {link.isArchived && (
                              <span className="px-2 py-0.5 text-xs font-medium rounded bg-gray-200 text-gray-600">Arsip</span>
                            )}
                          </div>
                        </div>
                      </td>
                      <td className="px-4 py-3">
                        <code className="text-xs text-gray-700 break-all block max-w-xs">{link.url}</code>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <span className="font-semibold text-gray-900">{link.clicks}</span>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <span className="font-semibold text-gray-900">{link.conversions}</span>
                      </td>
                      <td className="px-4 py-3 text-right">
                        <span className="font-bold text-green-600">{formatCurrency(link.revenue)}</span>
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center justify-center gap-1.5">
                          <button
                            onClick={() => copyToClipboard(link.url, link.id)}
                            className="p-1.5 rounded-lg bg-orange-100 hover:bg-orange-200 text-orange-700 transition-colors"
                            title="Copy link"
                          >
                            {copiedId === link.id ? <Check className="h-4 w-4 text-green-600" /> : <Copy className="h-4 w-4" />}
                          </button>
                          <a
                            href={link.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="p-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors"
                            title="Buka link"
                          >
                            <ExternalLink className="h-4 w-4" />
                          </a>
                          <button
                            onClick={() => toggleArchiveLink(link.id, link.isArchived)}
                            disabled={archivingId === link.id}
                            className={`p-1.5 rounded-lg transition-colors disabled:opacity-50 ${
                              link.isArchived
                                ? 'bg-blue-100 hover:bg-blue-200 text-blue-700'
                                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
                            }`}
                            title={link.isArchived ? 'Pulihkan' : 'Arsipkan'}
                          >
                            {archivingId === link.id ? (
                              <RefreshCw className="h-4 w-4 animate-spin" />
                            ) : link.isArchived ? (
                              <ArchiveRestore className="h-4 w-4" />
                            ) : (
                              <Archive className="h-4 w-4" />
                            )}
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Quick Links Info */}
        <div className="mt-6 grid md:grid-cols-2 gap-4">
          <div className="bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-5">
            <h3 className="font-semibold text-orange-900 mb-3 flex items-center gap-2">
              <Share2 className="h-5 w-5" />
              Cara Kerja Affiliate
            </h3>
            <ul className="space-y-2 text-sm text-gray-700">
              <li className="flex items-start gap-2">
                <span className="text-orange-600 font-bold">1.</span>
                <span>Generate link affiliate untuk produk yang ingin dipromosikan</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-orange-600 font-bold">2.</span>
                <span>Bagikan link ke calon pembeli (WhatsApp, sosmed, dll)</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-orange-600 font-bold">3.</span>
                <span>Setiap pembelian via link Anda = komisi masuk otomatis</span>
              </li>
            </ul>
          </div>
          
          <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-5">
            <h3 className="font-semibold text-blue-900 mb-3 flex items-center gap-2">
              <Crown className="h-5 w-5" />
              Tips Maksimalkan Komisi
            </h3>
            <ul className="space-y-2 text-sm text-gray-700">
              <li className="flex items-start gap-2">
                <span className="text-blue-600">‚úì</span>
                <span>Gunakan kupon untuk menarik pembeli baru</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-blue-600">‚úì</span>
                <span>Fokus promosi produk dengan komisi tertinggi</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-blue-600">‚úì</span>
                <span>Ikuti challenge untuk bonus tambahan</span>
              </li>
            </ul>
          </div>
        </div>

        {/* Generate Link Modal */}
        {showGenerateModal && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
                <h3 className="text-xl font-bold text-gray-900">Generate Link Affiliate</h3>
                <button
                  onClick={() => setShowGenerateModal(false)}
                  className="p-2 rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors"
                >
                  <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>

              <div className="p-6 space-y-5">
                {/* Link Type */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Tipe Link</label>
                  <div className="grid grid-cols-3 gap-2">
                    <button
                      onClick={() => setSelectedLinkType('SALESPAGE_INTERNAL')}
                      className={`p-3 rounded-lg border-2 transition-all text-left ${
                        selectedLinkType === 'SALESPAGE_INTERNAL'
                          ? 'border-blue-500 bg-blue-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="font-medium text-sm">Halaman Penjualan</div>
                      <div className="text-xs text-gray-500 mt-0.5">Link menuju sales page</div>
                    </button>
                    <button
                      onClick={() => setSelectedLinkType('CHECKOUT')}
                      className={`p-3 rounded-lg border-2 transition-all text-left ${
                        selectedLinkType === 'CHECKOUT'
                          ? 'border-green-500 bg-green-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="font-medium text-sm">Halaman Checkout</div>
                      <div className="text-xs text-gray-500 mt-0.5">Link checkout langsung</div>
                    </button>
                    <button
                      onClick={() => setSelectedLinkType('SALESPAGE_EXTERNAL')}
                      className={`p-3 rounded-lg border-2 transition-all text-left ${
                        selectedLinkType === 'SALESPAGE_EXTERNAL'
                          ? 'border-purple-500 bg-purple-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="font-medium text-sm">Link Alternatif</div>
                      <div className="text-xs text-gray-500 mt-0.5">Backup link (darurat)</div>
                    </button>
                  </div>
                </div>

                {/* Target Type */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Tipe Target</label>
                  <div className="grid grid-cols-3 gap-2">
                    <button
                      onClick={() => {
                        setSelectedTargetType('membership')
                        setSelectedTargetId('')
                      }}
                      className={`flex items-center justify-center gap-2 p-3 rounded-lg border-2 transition-all ${
                        selectedTargetType === 'membership'
                          ? 'border-orange-500 bg-orange-50 text-orange-700'
                          : 'border-gray-200 hover:border-gray-300 text-gray-700'
                      }`}
                    >
                      <Crown className="h-4 w-4" />
                      <span className="font-medium text-sm">Membership</span>
                    </button>
                    <button
                      onClick={() => {
                        setSelectedTargetType('product')
                        setSelectedTargetId('')
                      }}
                      className={`flex items-center justify-center gap-2 p-3 rounded-lg border-2 transition-all ${
                        selectedTargetType === 'product'
                          ? 'border-orange-500 bg-orange-50 text-orange-700'
                          : 'border-gray-200 hover:border-gray-300 text-gray-700'
                      }`}
                    >
                      <Package className="h-4 w-4" />
                      <span className="font-medium text-sm">Produk</span>
                    </button>
                    <button
                      onClick={() => {
                        setSelectedTargetType('course')
                        setSelectedTargetId('')
                      }}
                      className={`flex items-center justify-center gap-2 p-3 rounded-lg border-2 transition-all ${
                        selectedTargetType === 'course'
                          ? 'border-orange-500 bg-orange-50 text-orange-700'
                          : 'border-gray-200 hover:border-gray-300 text-gray-700'
                      }`}
                    >
                      <BookOpen className="h-4 w-4" />
                      <span className="font-medium text-sm">Kelas</span>
                    </button>
                  </div>
                </div>

                {/* Target Selection */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Pilih {selectedTargetType === 'membership' ? 'Paket Membership' : selectedTargetType === 'product' ? 'Produk' : 'Kursus'}
                  </label>
                  <select
                    value={selectedTargetId}
                    onChange={(e) => setSelectedTargetId(e.target.value)}
                    className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                  >
                    <option value="">Semua {selectedTargetType === 'membership' ? 'Paket' : selectedTargetType === 'product' ? 'Produk' : 'Kursus'}</option>
                    {selectedTargetType === 'membership' && memberships.map((item) => (
                      <option key={item.id} value={item.id}>
                        {item.name} - Rp {item.price?.toLocaleString('id-ID') || '0'}
                      </option>
                    ))}
                    {selectedTargetType === 'product' && products.map((item) => (
                      <option key={item.id} value={item.id}>
                        {item.name} - Rp {item.price?.toLocaleString('id-ID') || '0'}
                      </option>
                    ))}
                    {selectedTargetType === 'course' && courses.map((item) => (
                      <option key={item.id} value={item.id}>
                        {item.title} - Rp {Number(item.price || 0).toLocaleString('id-ID')}
                      </option>
                    ))}
                  </select>
                </div>

                {/* Coupon Selection */}
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    Pilih Kupon <span className="text-red-500">*Wajib</span>
                  </label>
                  <select
                    value={selectedCouponCode}
                    onChange={(e) => setSelectedCouponCode(e.target.value)}
                    className="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    required
                  >
                    <option value="">-- Pilih Kupon --</option>
                    {coupons.map((coupon) => (
                      <option key={coupon.id} value={coupon.code}>
                        {coupon.source === 'affiliate' ? 'üè∑Ô∏è ' : '‚≠ê '}
                        {coupon.code} - {coupon.discountType === 'PERCENTAGE' ? `${coupon.discountValue}%` : `Rp ${Number(coupon.discountValue).toLocaleString('id-ID')}`}
                      </option>
                    ))}
                  </select>
                  
                  {coupons.length === 0 && (
                    <div className="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                      <p className="text-sm text-amber-800">
                        ‚ö†Ô∏è Anda belum punya kupon. <a href="/affiliate/coupons" className="underline font-semibold">Buat kupon dulu</a>
                      </p>
                    </div>
                  )}
                  
                  {selectedCouponCode && (
                    <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                      <p className="text-sm text-green-800">
                        ‚úì Kupon <span className="font-mono font-semibold">{selectedCouponCode}</span> akan otomatis terisi di checkout
                      </p>
                    </div>
                  )}
                </div>

                {/* Info */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <p className="text-sm text-blue-800">
                    üí° Link akan otomatis tracking referral Anda. Komisi masuk setiap ada pembelian via link ini.
                  </p>
                </div>

                {/* Actions */}
                <div className="flex gap-3 pt-2">
                  <button
                    onClick={() => setShowGenerateModal(false)}
                    className="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
                  >
                    Batal
                  </button>
                  <button
                    onClick={generateNewLink}
                    disabled={generating || !selectedCouponCode}
                    className="flex-1 px-4 py-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-semibold flex items-center justify-center gap-2"
                  >
                    {generating ? (
                      <>
                        <RefreshCw className="h-4 w-4 animate-spin" />
                        Membuat...
                      </>
                    ) : (
                      <>
                        <Plus className="h-4 w-4" />
                        Generate Link
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
